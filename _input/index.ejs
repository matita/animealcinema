<%- include('_includes/header') %>
<%
  const now = new Date();
  const showingMovies = movies
    .filter(m => new Date(m.theaterReleaseDate) < now && (!m.theaterEndDate || new Date(m.theaterEndDate) > now))
    .sort((a, b) => a.title.localeCompare(b.title));
  const comingMovies = movies
    .filter(m => new Date(m.theaterReleaseDate) > now)
    .sort((a, b) => a.theaterReleaseDate.localeCompare(b.theaterReleaseDate));
  const announcedMovies = movies
    .filter(m => !m.theaterReleaseDate)
    .sort((a, b) => a.title.localeCompare(b.title));

  const relevantMovies = movies
    .filter((m) => !m.theaterEndDate || new Date(m.theaterEndDate) > now)
    .sort((a, b) => a.theaterReleaseDate?.localeCompare(b.theaterReleaseDate))
    .reduce((agg, movie) => {
      const releaseDate = new Date(movie.theaterReleaseDate);
      const relativeDate = (movie.theaterReleaseDate && !/^\d{4}$/.test(movie.theaterReleaseDate) && formatRelativeDate(releaseDate)) || 'Annunciati';
      agg[relativeDate] = agg[relativeDate] || [];
      agg[relativeDate].push(movie);
      return agg;
    }, {});

  function mostPopularBackdrop() {
    const backdropPath = Object.values(relevantMovies).flat()
      .filter((m) => m.tmdbMovie?.backdrop_path)
      .sort((a, b) => b.tmdbMovie.popularity - a.tmdbMovie.popularity)
      [0]?.tmdbMovie.backdrop_path;
    return backdropPath && `/images/w1280${backdropPath}`;
  }

  function formatRelativeDate(date) {
    const now = new Date();
    const d = date instanceof Date ? date : new Date(date);
    const diffTime = d - now;
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
    
    let unit;
    let value;
    
    /*if (Math.abs(diffDays) < 7) {
        unit = 'day';
        value = diffDays + 1;
    } else */if (Math.abs(diffDays) < 30) {
        unit = 'week';
        value = Math.round(diffDays / 7);
    } else if (Math.abs(diffDays) < 365) {
        unit = 'month';
        value = Math.round(diffDays / 30);
    } else {
        unit = 'year';
        value = Math.round(diffDays / 365);
    }
    
    return new Intl.RelativeTimeFormat('it', { numeric: 'auto' }).format(value, unit);
  }
%>

<div class="hero" style="background-image: linear-gradient(to bottom, rgba(52.5, 52.5, 52.5, 0.2), rgba(52.5, 52.5, 52.5, 1)), url(<%= mostPopularBackdrop() %>)">
  <h1>Anime al cinema in Italia</h1>
</div>

<main>
  
<% for (const label in relevantMovies) { %>
  <section>
    <h2><%= label %></h2>
  
    <div class="movie-list">
      <% for (const movie of relevantMovies[label]) { %>
        <%- include('_includes/movie', { movie }) %>
      <% } %>
      </div>
  </section>
<% } %>
</main>

<%- include('_includes/footer') %>